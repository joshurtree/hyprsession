on:
  push:
    branches:
      - main
    paths:
      - 'Cargo.toml'

name: Publish
jobs:
  check_context_tokens:
    name: Check Required Context Tokens
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Verify Required Secrets and Variables
        run: |
          echo "ðŸ” Checking required context tokens..."
          
          # Required secrets for crates.io publishing
          if [ -z "${{ secrets.CRATES_IO_API_TOKEN }}" ]; then
            echo "âŒ CRATES_IO_API_TOKEN secret is missing"
            exit 1
          else
            echo "âœ… CRATES_IO_API_TOKEN secret is present"
          fi
          
          # Required secrets for AUR publishing
          if [ -z "${{ secrets.AUR_USERNAME }}" ]; then
            echo "âŒ AUR_USERNAME secret is missing"
            exit 1
          else
            echo "âœ… AUR_USERNAME secret is present"
          fi
          
          if [ -z "${{ secrets.AUR_EMAIL }}" ]; then
            echo "âŒ AUR_EMAIL secret is missing"
            exit 1
          else
            echo "âœ… AUR_EMAIL secret is present"
          fi
          
          if [ -z "${{ secrets.AUR_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ AUR_SSH_PRIVATE_KEY secret is missing"
            exit 1
          else
            echo "âœ… AUR_SSH_PRIVATE_KEY secret is present"
          fi
          
          # Required default token (should always exist)
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "âŒ GITHUB_TOKEN secret is missing"
            exit 1
          else
            echo "âœ… GITHUB_TOKEN secret is present"
          fi
          
          # Optional variables (will use defaults if not set)
          echo "ðŸ“‹ Checking optional variables..."
          echo "CRATES_IO_INITIAL_WAIT: ${{ vars.CRATES_IO_INITIAL_WAIT || 'not set (will use default: 180)' }}"
          echo "CRATES_IO_RETRY_WAIT: ${{ vars.CRATES_IO_RETRY_WAIT || 'not set (will use default: 60)' }}"
          
          echo "âœ… All required context tokens are present!"

  audit:
    name: Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: check_context_tokens
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  build_linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: check_context_tokens
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable 
      - name: 'Build'
        run: cargo build --release --all-features

  add_version_tag:
    name: Add Version Tag
    needs:
      - check_context_tokens
      - build_linux

    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version detected: $VERSION"

      - name: Create Git Tag
        run: |
          git config --global user.name " github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

  crates_io_publish:
    name: Publish (crates.io)
    needs:
      - check_context_tokens
      - audit
      - build_linux
      - add_version_tag

    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: cargo-release Cache
        id: cargo_release_cache
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/cargo-release
          key: ${{ runner.os }}-cargo-release

      - run: cargo install cargo-release
        if: steps.cargo_release_cache.outputs.cache-hit != 'true'

      - name: cargo login
        run: cargo login ${{ secrets.CRATES_IO_API_TOKEN }}

      - name: "cargo release publish"
        run: |-
          cargo release \
            publish \
            --workspace \
            --all-features \
            --allow-branch main \
            --no-confirm \
            --execute

  aur_publish:
    name: Publish (AUR)
    needs:
      - audit
      - build_linux
      - add_version_tag
      - crates_io_publish

    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version detected: $VERSION"

      - name: Wait for crates.io availability
        run: |
          echo "Waiting for package to be available on crates.io..."
          echo "Initial wait of ${{ vars.CRATES_IO_INITIAL_WAIT || '180' }} seconds..."
          sleep ${{ vars.CRATES_IO_INITIAL_WAIT || '180' }}
          for i in {1..30}; do
            if curl -s "https://crates.io/api/v1/crates/hyprsession/${{ steps.version.outputs.version }}" | grep -q "\"num\":\"${{ steps.version.outputs.version }}\""; then
              echo "Package found on crates.io"
              break
            fi
            echo "Attempt $i: Package not yet available, waiting ${{ vars.CRATES_IO_RETRY_WAIT || '60' }} seconds..."
            sleep ${{ vars.CRATES_IO_RETRY_WAIT || '60' }}
          done

      - name: Get SHA256 checksum from crates.io
        id: checksum
        run: |
          # Download the crate to get the real checksum
          wget -q "https://crates.io/api/v1/crates/hyprsession/${{ steps.version.outputs.version }}/download" -O hyprsession-${{ steps.version.outputs.version }}.crate
          SHA256=$(sha256sum hyprsession-${{ steps.version.outputs.version }}.crate | cut -d' ' -f1)
          echo "checksum=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
        with:
          pkgname: hyprsession
          pkgbuild: |
            # Maintainer: Josh Andrews <coding@joshandrews.xyz>
            pkgname=hyprsession
            pkgver=${{ steps.version.outputs.version }}
            pkgrel=1
            pkgdesc="Saves hyprland sessions"
            arch=('x86_64')
            url="https://github.com/joshurtree/hyprsession"
            license=('GPL-3.0-or-later')
            depends=()
            makedepends=('rust' 'cargo')
            source=("$pkgname-$pkgver.tar.gz::https://crates.io/api/v1/crates/$pkgname/$pkgver/download")
            sha256sums=('${{ steps.checksum.outputs.checksum }}')

            prepare() {
              cd "$pkgname-$pkgver"
              # Update the lockfile
              cargo update
            }

            build() {
              cd "$pkgname-$pkgver"
              export RUSTUP_TOOLCHAIN=stable
              export CARGO_TARGET_DIR=target
              cargo build --frozen --release --all-features
            }

            check() {
              cd "$pkgname-$pkgver"
              export RUSTUP_TOOLCHAIN=stable
              cargo test --frozen --all-features
            }

            package() {
              cd "$pkgname-$pkgver"
              install -Dm755 "target/release/$pkgname" "$pkgdir/usr/bin/$pkgname"
              install -Dm644 "README.md" "$pkgdir/usr/share/doc/$pkgname/README.md"
              install -Dm644 "LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
            }
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to version ${{ steps.version.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
