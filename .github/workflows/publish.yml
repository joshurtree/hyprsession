on:
  push:
    branches:
      - release/*
    paths:
      - 'Cargo.toml'
      - '.github/workflows/publish.yml'

name: Publish
jobs:
  check_context_tokens:
    name: Check Required Context Tokens
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Verify Required Secrets and Variables
        run: |
          echo "ðŸ” Checking required context tokens..."
          
          # Required secrets for crates.io publishing
          if [ -z "${{ secrets.CRATES_IO_API_TOKEN }}" ]; then
            echo "âŒ CRATES_IO_API_TOKEN secret is missing"
            exit 1
          else
            echo "âœ… CRATES_IO_API_TOKEN secret is present"
          fi
          
          # Required secrets for AUR publishing
          if [ -z "${{ secrets.AUR_USERNAME }}" ]; then
            echo "âŒ AUR_USERNAME secret is missing"
            exit 1
          else
            echo "âœ… AUR_USERNAME secret is present"
          fi
          
          if [ -z "${{ secrets.AUR_EMAIL }}" ]; then
            echo "âŒ AUR_EMAIL secret is missing"
            exit 1
          else
            echo "âœ… AUR_EMAIL secret is present"
          fi
          
          if [ -z "${{ secrets.AUR_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ AUR_SSH_PRIVATE_KEY secret is missing"
            exit 1
          else
            echo "âœ… AUR_SSH_PRIVATE_KEY secret is present"
          fi
          
          # Required default token (should always exist)
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "âŒ GITHUB_TOKEN secret is missing"
            exit 1
          else
            echo "âœ… GITHUB_TOKEN secret is present"
          fi
          
          # Optional variables (will use defaults if not set)
          echo "ðŸ“‹ Checking optional variables..."
          echo "PUBLISH_INITIAL_WAIT: ${{ vars.PUBLISH_INITIAL_WAIT || 'not set (will use default: 180)' }}"
          echo "PUBLISH_RETRY_WAIT: ${{ vars.PUBLISH_RETRY_WAIT || 'not set (will use default: 60)' }}"

          echo "âœ… All required context tokens are present!"

  audit:
    name: Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: check_context_tokens
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  build_linux:
    name: Build and Test (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: check_context_tokens
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable 
      - name: 'Build'
        run: cargo build --release --all-features

  version:
    name: Add Version Tag
    needs:
      - check_context_tokens
      - build_linux
      - audit

    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - name: Get version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/' | sed 's/-.*//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release=$RELEASE_SUFFIX" >> $GITHUB_OUTPUT
          echo "Version detected: $VERSION"
          echo "Release suffix detected: $RELEASE_SUFFIX"
          echo "Full version detected: $FULL_VERSION"

      - name: Create Git Tag
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          TAG="v${{ steps.version.outputs.version }}"
          
          # Fetch all tags from remote to ensure we have the latest
          git fetch --tags --force
          
          # Check if tag already exists (locally or remotely)
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, moving it to the latest commit"
            # Delete the tag locally
            git tag -d "$TAG"
            # Delete the tag remotely (force push to delete)
            git push --force origin ":refs/tags/$TAG" || true
          else
            echo "Tag $TAG does not exist yet, creating new tag"
          fi
          
          # Create and push the new tag
          git tag "$TAG"
          git push origin "$TAG"

  crates_io_publish:
    name: Publish (crates.io)
    needs:
      - check_context_tokens
      - audit
      - build_linux
      - version

    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: cargo-release Cache
        id: cargo_release_cache
        uses: actions/cache@v3
        with:
          path: ~/.cargo/bin/cargo-release
          key: ${{ runner.os }}-cargo-release

      - run: cargo install cargo-release
        if: steps.cargo_release_cache.outputs.cache-hit != 'true'

      - name: cargo login
        run: cargo login ${{ secrets.CRATES_IO_API_TOKEN }}

      - name: "cargo release publish"
        run: |-
          cargo release \
            publish \
            --workspace \
            --all-features \
            --allow-branch main \
            --no-confirm \
            --execute

      - name: Verify crates.io publication
        run: |
          PACKAGE_NAME="hyprsession"
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/' | sed 's/-.*//')
          INITIAL_WAIT=${{ vars.PUBLISH_INITIAL_WAIT || 10 }}
          RETRY_WAIT=${{ vars.PUBLISH_RETRY_WAIT || 10 }}
          MAX_ATTEMPTS=6
          
          echo "Verifying publication of $PACKAGE_NAME v$VERSION on crates.io..."
          echo "Using INITIAL_WAIT=${INITIAL_WAIT}s, RETRY_WAIT=${RETRY_WAIT}s"
          
          # Wait for crates.io to update
          echo "Waiting ${INITIAL_WAIT}s for crates.io to update..."
          sleep $INITIAL_WAIT
          
          # Check if the version is available
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: Checking crates.io..."
            if curl -s "https://crates.io/api/v1/crates/$PACKAGE_NAME" | grep -q "\"vers\":\"$VERSION\""; then
              echo "âœ“ Successfully verified $PACKAGE_NAME v$VERSION is published on crates.io"
              exit 0
            fi
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Version not found yet, waiting ${RETRY_WAIT}s..."
              sleep $RETRY_WAIT
            fi
          done
          
          echo "âœ— Failed to verify publication on crates.io after $MAX_ATTEMPTS attempts"
          exit 1

  aur_publish:
    name: Publish (AUR)
    needs:
      - audit
      - build_linux
      - version

    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Get version from Cargo.toml
        id: version
        run: |
          FULL_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          VERSION=$(echo "$FULL_VERSION" | sed 's/-.*//')
          RELEASE_SUFFIX=$(echo "$FULL_VERSION" | grep -oP '(?<=-).*$' || echo "1")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release=$RELEASE_SUFFIX" >> $GITHUB_OUTPUT
          echo "Version detected: $VERSION"
          echo "Release suffix detected: $RELEASE_SUFFIX"

      - name: Get SHA256 checksum from repository
        id: checksum
        run: |
          # Create a temporary tarball from the repository
          git archive --format=tar.gz --prefix=hyprsession-${{ steps.version.outputs.version }}/ HEAD > hyprsession-${{ steps.version.outputs.version }}.tar.gz
          SHA256=$(sha256sum hyprsession-${{ steps.version.outputs.version }}.tar.gz | cut -d' ' -f1)
          echo "checksum=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Generate PKGBUILD file
        run: |-
          cat <<EOF > PKGBUILD
          # Maintainer: Josh Andrews <coding@joshandrews.xyz>
          pkgname=hyprsession
          pkgver=${{ steps.version.outputs.version }}
          pkgrel=${{ steps.version.outputs.release }}
          pkgdesc="Saves hyprland sessions"
          arch=('x86_64')
          url="https://github.com/joshurtree/hyprsession"
          license=('GPL-3.0-or-later')
          depends=()
          makedepends=('rust' 'cargo')
          source=("\$pkgname-\$pkgver.tar.gz::https://github.com/joshurtree/hyprsession/archive/refs/tags/v\$pkgver.tar.gz")
          sha256sums=('${{ steps.checksum.outputs.checksum }}')

          build() {
            cd "\$pkgname-\$pkgver"
            export RUSTUP_TOOLCHAIN=stable
            export CARGO_TARGET_DIR=target
            cargo build --frozen --release --all-features
          }

          check() {
            cd "\$pkgname-\$pkgver"
            export RUSTUP_TOOLCHAIN=stable
            cargo test --frozen --all-features
          }

          package() {
            cd "\$pkgname-\$pkgver"
            install -Dm755 "target/release/\$pkgname" "\$pkgdir/usr/bin/\$pkgname"
            install -Dm644 "README.md" "\$pkgdir/usr/share/doc/\$pkgname/README.md"
            install -Dm644 "LICENSE" "\$pkgdir/usr/share/licenses/\$pkgname/LICENSE"
          }
          EOF

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: hyprsession
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to version ${{ steps.version.outputs.version }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519

      - name: Verify AUR publication
        run: |
          PACKAGE_NAME="hyprsession"
          VERSION="${{ steps.version.outputs.version }}"
          INITIAL_WAIT=${{ vars.PUBLISH_INITIAL_WAIT || 15 }}
          RETRY_WAIT=${{ vars.PUBLISH_RETRY_WAIT || 15 }}
          MAX_ATTEMPTS=4
          
          echo "Verifying publication of $PACKAGE_NAME v$VERSION on AUR..."
          echo "Using INITIAL_WAIT=${INITIAL_WAIT}s, RETRY_WAIT=${RETRY_WAIT}s"
          
          # Wait for AUR to update
          echo "Waiting ${INITIAL_WAIT}s for AUR to update..."
          sleep $INITIAL_WAIT
          
          # Check if the package is available via AUR RPC API
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: Checking AUR..."
            RESPONSE=$(curl -s "https://aur.archlinux.org/rpc/?v=5&type=info&arg=$PACKAGE_NAME")
            
            if echo "$RESPONSE" | grep -q "\"resultcount\":1"; then
              CURRENT_VERSION=$(echo "$RESPONSE" | grep -oP '"Version":"[^"]*"' | cut -d'"' -f4)
              echo "Found package on AUR with version: $CURRENT_VERSION"
              
              if [ "$CURRENT_VERSION" = "$VERSION" ]; then
                echo "âœ“ Successfully verified $PACKAGE_NAME v$VERSION is published on AUR"
                exit 0
              else
                echo "Version mismatch: expected $VERSION, found $CURRENT_VERSION"
              fi
            else
              echo "Package not found on AUR yet"
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Waiting ${RETRY_WAIT}s before retry..."
              sleep $RETRY_WAIT
            fi
          done
          
          echo "âœ— Failed to verify publication on AUR after $MAX_ATTEMPTS attempts"
          exit 1
